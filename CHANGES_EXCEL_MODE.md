# Excel Mode — Minimal Changes (2025-09-15)

Краткая запись того, что сделано в ветке `ebay_my` по переходу на вход из Excel и расширенное логирование. Изменения изолированы — папка `ebay` не трогалась.

## Что изменено
- Источник задач: добавлен режим чтения из локального Excel (однократно при старте).
- Фильтр цены: применяется только на этапе каталога. Если цена в Excel не указана — каталог не фильтруем.
- Очереди: переименованы, чтобы не конфликтовать с основным проектом (`cl_my`, `pw_my`).
- Логирование: добавлен управляемый флагом подробный лог причин отбора/отсечения объявлений.

## Затронутые файлы
- Добавлены
  - `ebay_my/excel_source.py` — чтение Excel (A: запросы через запятую, B: MaxPrice в USD; пусто → без лимита).
  - `ebay_my/main_excel.py` — входная точка для Excel-режима.
  - `ebay_my/excel_log.py` — включаемое подробное логирование решений.
  - `ebay_my/__init__.py` — инициализация пакета.
- Изменены (точечно)
  - `ebay_my/main.py`
    - `broker_cl/pw` → `cl_my/pw_my`.
    - `task_collect_loop(query, proxy, max_price=None)` — проброс лимита.
    - `catalog(..., max_price=None)` — фильтр по цене в каталоге; при `None` — без фильтра.
    - Подробные логи по решениям для каждого лота и сводка по странице.

## Формат Excel
- Колонка A: строка запросов (артикулы) через запятую, например: `12345, ABC-678, qwe-99`.
- Колонка B: максимальная цена в USD; допускается дробная запятая/точка. Пусто — значит без лимита.

## Переменные окружения (.env)
- `EXCEL_PATH` — путь к Excel; по умолчанию `queries.xlsx` в корне проекта.
- `EXCEL_VERBOSE=1` — включить подробное логирование причин (по умолчанию выключено).
- `EXCEL_LOG_FILE` — путь к файлу логов (по умолчанию `excel_verbose.log` в корне).

## Как запускать Excel-режим
- Заполнить Excel по формату выше.
- Указать при необходимости путь в `.env`.
- Запуск: `python -m ebay_my.main_excel` (или `python ebay_my/main_excel.py`).

## Подробное логирование (при `EXCEL_VERBOSE=1`)
Пишется отдельным логгером в файл `EXCEL_LOG_FILE` компактными строками `key=value`:
- `EVT=excel_pair query=... max_price=... excel_path=...` — распарсенные пары из Excel.
- `EVT=task_collect_start query=... threshold=...` — старт задачи по запросу.
- На уровне каталога для каждого лота:
  - `EVT=catalog_item_decision query=... page=... href=... price=... threshold=... decision=include|skip reason=no_max_price|below_threshold|above_threshold|price_parse_failed`
  - `EVT=catalog_page_summary query=... page=... scanned=... accepted=... threshold=...`

## Поведение фильтра
- Если `max_price is None` (ячейка B пуста) — не фильтруем лоты в каталоге.
- Иначе парсим цену лота на карточке каталога:
  - парсинг не удался → `skip (price_parse_failed)`;
  - цена < `max_price` → `include`;
  - иначе → `skip (above_threshold)`.

## Совместимость и безопасность
- DB-режим в `main.py` сохранён; задачи из БД кладутся в `cl_my` с лимитом `MAX_PRICE` (как раньше).
- Папка `ebay` не затрагивалась.
- Логирование включается только по флагу, накладные расходы минимальны.

## Известные нюансы
- Если eBay меняет разметку цены в каталоге, возможен `price_parse_failed` и лот будет пропущен при наличии лимита — это ожидаемо и отражается в логах.
- Размер `excel_verbose.log` может расти на больших объёмах; контролируется флагом и временем запуска.

## Быстрый чеклист
- [ ] `EXCEL_PATH` задан или файл `queries.xlsx` лежит в корне.
- [ ] `EXCEL_VERBOSE=1` включён для отладки (опционально).
- [ ] `redis` доступен; очереди `cl_my`/`pw_my` не конфликтуют с основным процессом.

---
Ответственный: текущая сессия (чат-транзакция). Дата: 2025-09-15.
